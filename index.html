<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è¨‚å–®èˆ‡æ´»å‹•ç®¡ç†ç³»çµ±</title>
    <!-- å¼•å…¥ Tailwind CSS ä»¥é€²è¡Œå¿«é€Ÿ UI é–‹ç™¼ -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- å¼•å…¥ FullCalendar çš„ä¸»è¦æ ¸å¿ƒåº« -->
    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.js'></script>
    <!-- å¼•å…¥ DayGrid Plugin (ç”¨æ–¼æœˆã€é€±ã€æ—¥è¦–åœ–) -->
    <script src='https://cdn.jsdelivr.net/npm/@fullcalendar/daygrid@6.1.11/index.global.min.js'></script>
    <!-- å¼•å…¥ Interaction Plugin (ç”¨æ–¼é»æ“Šã€æ‹–æ›³ç­‰äº’å‹•) -->
    <script src='https://cdn.jsdelivr.net/npm/@fullcalendar/interaction@6.1.11/index.global.min.js'></script>

    <style>
        /* è‡ªè¨‚æ¨£å¼ï¼Œè®“æœˆæ›†åœ¨è¡Œå‹•è£ç½®ä¸Šæœ‰æ›´å¥½çš„é¡¯ç¤ºæ•ˆæœ */
        :root {
            --fc-button-bg-color: #3b82f6; /* è—è‰²æŒ‰éˆ• */
            --fc-button-border-color: #3b82f6;
            --fc-button-hover-bg-color: #2563eb;
            --fc-button-hover-border-color: #2563eb;
            --fc-today-bg-color: rgba(253, 224, 71, 0.2); /* æ·¡é»ƒè‰²æ¨™ç¤ºä»Šå¤© */
        }
        .fc .fc-toolbar-title {
            font-size: 1.25rem;
        }
        .fc .fc-daygrid-day-number {
            font-size: 0.9rem;
            padding: 4px;
        }
        .fc-event {
            cursor: pointer;
            transition: background-color: 0.2s;
        }
        .fc-event:hover {
            opacity: 0.8;
        }
        /* éš±è—å…ƒç´ ç”¨çš„ class */
        .hidden {
            display: none;
        }
        /* Modal å½ˆå‡ºè¦–çª—æ¨£å¼ */
        .modal-backdrop {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            z-index: 40;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .modal-content {
            position: relative;
            top: auto;
            left: auto;
            transform: none;
            z-index: 50;
        }
    </style>
</head>
<body class="bg-gray-100 font-sans antialiased">

    <div id="app" class="container mx-auto p-4 md:p-6">
        <header class="mb-6">
            <h1 class="text-3xl font-bold text-gray-800">è¨‚å–®èˆ‡æ´»å‹•ç®¡ç†ç³»çµ±</h1>
            <p class="text-gray-600">è¼•é¬†ç®¡ç†æ‚¨çš„æ´»å‹•èˆ‡å ±åè³‡æ–™ã€‚</p>
        </header>

        <!-- é é¢åˆ‡æ›æŒ‰éˆ• -->
        <nav class="flex space-x-2 mb-6 bg-white p-2 rounded-lg shadow-sm">
            <button id="show-calendar-btn" class="px-4 py-2 text-sm font-semibold text-white bg-blue-500 rounded-md shadow-sm hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50 transition-colors">
                æœˆæ›†æª¢è¦–
            </button>
            <button id="show-order-btn" class="px-4 py-2 text-sm font-semibold text-gray-700 bg-gray-200 rounded-md hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-gray-400 focus:ring-opacity-50 transition-colors">
                è¨‚å–®åŒ¯å…¥
            </button>
            <button id="show-customer-btn" class="px-4 py-2 text-sm font-semibold text-gray-700 bg-gray-200 rounded-md hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-gray-400 focus:ring-opacity-50 transition-colors">
                å®¢æˆ¶åå–®
            </button>
        </nav>

        <!-- æœˆæ›†è¦–åœ– -->
        <main id="calendar-view" class="bg-white p-4 rounded-lg shadow">
            <div class="flex flex-wrap justify-end gap-2 mb-4">
                <button id="manage-instructors-btn" class="px-4 py-2 text-xs font-semibold text-gray-700 bg-yellow-100 rounded-md hover:bg-yellow-200 border border-yellow-200">ç®¡ç†è¬›å¸«</button>
                <button id="export-month-btn" class="px-4 py-2 text-xs font-semibold text-gray-700 bg-green-100 rounded-md hover:bg-green-200 border border-green-200">åŒ¯å‡ºæœ¬æœˆå ±å</button>
            </div>
            <div id='calendar'></div>
        </main>

        <!-- è¨‚å–®åŒ¯å…¥è¦–åœ– -->
        <main id="order-view" class="hidden bg-white p-6 rounded-lg shadow">
            <div class="flex justify-between items-center mb-6">
                 <h2 class="text-2xl font-bold text-gray-800">æ–°å¢å ±åè¨‚å–®</h2>
                 <button id="batch-import-btn" class="px-4 py-2 text-sm font-semibold text-white bg-indigo-500 rounded-md hover:bg-indigo-600">æ‰¹æ¬¡åŒ¯å…¥è¨‚å–®</button>
            </div>
            <form id="order-form" class="space-y-4">
                <div class="relative">
                    <label for="event-search-input" class="block text-sm font-medium text-gray-700">é¸æ“‡æ´»å‹•</label>
                    <input type="text" id="event-search-input" placeholder="é»æ“Šæˆ–è¼¸å…¥é—œéµå­—æœå°‹æ´»å‹•..." class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-md cursor-pointer" readonly>
                     <input type="hidden" id="event-select-hidden" name="eventId">
                    <div id="event-dropdown-list" class="hidden absolute z-20 w-full mt-1 bg-white border border-gray-300 rounded-md shadow-lg max-h-72 overflow-y-auto">
                        <!-- Grouped event list will be injected here -->
                    </div>
                </div>
                <div>
                    <label for="customer-name" class="block text-sm font-medium text-gray-700">å ±åè€…å§“å (å¯æœå°‹èˆŠå®¢)</label>
                    <div class="relative">
                        <input type="text" id="customer-name" name="customerName" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500" autocomplete="off">
                        <div id="customer-suggestions" class="hidden absolute z-10 w-full bg-white border border-gray-300 rounded-md mt-1 shadow-lg max-h-60 overflow-y-auto">
                            <!-- æœå°‹å»ºè­°æœƒå‹•æ…‹æ’å…¥é€™è£¡ -->
                        </div>
                    </div>
                </div>
                 <div>
                    <label for="customer-phone" class="block text-sm font-medium text-gray-700">è¯çµ¡é›»è©± (ç”¨ä»¥å»ºç«‹å®¢æˆ¶è³‡æ–™)</label>
                    <input type="tel" id="customer-phone" name="customerPhone" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                </div>
                <div>
                    <label for="customer-email" class="block text-sm font-medium text-gray-700">é›»å­éƒµä»¶ (é¸å¡«)</label>
                    <input type="email" id="customer-email" name="customerEmail" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                </div>
                <div>
                    <label for="customer-id" class="block text-sm font-medium text-gray-700">èº«åˆ†è­‰å­—è™Ÿ (é¸å¡«)</label>
                    <input type="text" id="customer-id" name="customerIdNumber" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                </div>
                <div>
                    <label for="customer-dob" class="block text-sm font-medium text-gray-700">å‡ºç”Ÿå¹´æœˆæ—¥ (é¸å¡«)</label>
                    <input type="date" id="customer-dob" name="customerDob" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                </div>
                <div>
                    <label for="customer-occupation" class="block text-sm font-medium text-gray-700">è·æ¥­ (é¸å¡«)</label>
                    <input type="text" id="customer-occupation" name="customerOccupation" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                </div>
                <div class="flex items-start">
                    <div class="flex items-center h-5">
                        <input id="addon-transport" name="addonTransport" type="checkbox" class="focus:ring-blue-500 h-4 w-4 text-blue-600 border-gray-300 rounded">
                    </div>
                    <div class="ml-3 text-sm">
                        <label for="addon-transport" class="font-medium text-gray-700">åŠ è³¼é …ç›®ï¼šäº¤é€šæ¥é€</label>
                    </div>
                </div>
                
                <!-- å ±åä¾†æº -->
                <div class="space-y-2 border-t pt-4">
                    <div class="flex justify-between items-center">
                        <label class="block text-sm font-medium text-gray-700">å ±åä¾†æº (å¯è¤‡é¸)</label>
                        <button type="button" id="manage-sources-btn" class="text-xs text-blue-600 hover:underline">ç®¡ç†ä¾†æºé¸é …</button>
                    </div>
                    <div id="registration-source-container" class="grid grid-cols-2 sm:grid-cols-3 gap-2">
                        <!-- å‹•æ…‹è¼‰å…¥çš„ä¾†æºé¸é …æœƒå‡ºç¾åœ¨é€™è£¡ -->
                    </div>
                </div>

                <!-- è‡ªè¨‚æ¬„ä½å®¹å™¨ -->
                <div id="custom-fields-container" class="space-y-4 border-t pt-4">
                    <!-- å‹•æ…‹æ–°å¢çš„è‡ªè¨‚æ¬„ä½æœƒå‡ºç¾åœ¨é€™è£¡ -->
                </div>

                <!-- åŠŸèƒ½æŒ‰éˆ• -->
                <div class="pt-2 space-y-3">
                    <button type="button" id="add-custom-field-btn" class="w-full flex justify-center py-2 px-4 border border-dashed border-gray-400 rounded-md shadow-sm text-sm font-medium text-gray-700 bg-gray-50 hover:bg-gray-100 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                        ï¼‹ æ–°å¢è‡ªè¨‚æ¬„ä½
                    </button>
                    <button type="submit" class="w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                        æ–°å¢è¨‚å–®
                    </button>
                </div>
            </form>
        </main>
        
        <!-- å®¢æˆ¶åå–®è¦–åœ– -->
        <main id="customer-view" class="hidden bg-white p-6 rounded-lg shadow">
             <h2 class="text-2xl font-bold text-gray-800 mb-4">å®¢æˆ¶åå–®</h2>
             <div class="mb-4">
                <input type="text" id="customer-search-input" placeholder="ä¾å§“åæˆ–é›»è©±æœå°‹å®¢æˆ¶..." class="w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500">
             </div>
             <div id="customer-list-container" class="max-h-[70vh] overflow-y-auto">
                <!-- å®¢æˆ¶åˆ—è¡¨æœƒå‹•æ…‹æ’å…¥é€™è£¡ -->
             </div>
        </main>
    </div>

    <!-- æ–°å¢/ç·¨è¼¯æ´»å‹• Modal -->
    <div id="add-event-modal" class="hidden modal-backdrop">
        <div class="modal-content bg-white w-11/12 md:max-w-md mx-auto rounded-lg shadow-xl p-6">
            <h3 class="text-xl font-bold mb-4" id="event-modal-title">æ–°å¢æ´»å‹•</h3>
            <form id="event-form" class="space-y-4">
                <input type="hidden" id="event-id">
                <div>
                    <label for="event-title" class="block text-sm font-medium text-gray-700">æ´»å‹•æ¨™é¡Œ</label>
                    <input type="text" id="event-title" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                    <input type="hidden" id="event-date">
                </div>
                <div>
                    <label for="event-instructor-select" class="block text-sm font-medium text-gray-700">å¸¶åœ˜è¬›å¸« (é¸å¡«)</label>
                    <select id="event-instructor-select" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                        <option value="">ç„¡</option>
                        <!-- Instructor options will be injected here -->
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">æ´»å‹•é¡è‰²</label>
                    <div id="color-palette" class="flex space-x-2 mt-2">
                        <!-- Colors will be injected here by JS -->
                    </div>
                    <input type="hidden" id="event-color">
                </div>
                <div class="mt-6 flex justify-between items-center">
                    <div>
                         <button type="button" id="delete-event-btn" class="hidden bg-red-600 text-white px-4 py-2 rounded-md hover:bg-red-700">åˆªé™¤æ´»å‹•</button>
                    </div>
                    <div class="flex space-x-3">
                        <button type="button" id="cancel-event-form" class="bg-gray-200 text-gray-700 px-4 py-2 rounded-md hover:bg-gray-300">å–æ¶ˆ</button>
                        <button type="submit" class="bg-blue-500 text-white px-4 py-2 rounded-md hover:bg-blue-600">å„²å­˜</button>
                    </div>
                </div>
            </form>
        </div>
    </div>
    
    <!-- æŸ¥çœ‹å ±åè€… Modal -->
    <div id="view-registrations-modal" class="hidden modal-backdrop">
        <div class="modal-content bg-white w-11/12 md:max-w-lg mx-auto rounded-lg shadow-xl p-6">
            <div class="flex justify-between items-center mb-4">
                <h3 id="registrations-title" class="text-xl font-bold">å ±ååˆ—è¡¨</h3>
                <div class="flex items-center space-x-2">
                     <button id="edit-event-btn" class="px-3 py-1 text-xs font-semibold text-white bg-yellow-500 rounded-md hover:bg-yellow-600">ç·¨è¼¯æ´»å‹•</button>
                     <button id="export-event-btn" class="px-3 py-1 text-xs font-semibold text-white bg-green-600 rounded-md hover:bg-green-700">åŒ¯å‡ºæ­¤æ´»å‹•</button>
                     <button id="export-day-from-modal-btn" class="px-3 py-1 text-xs font-semibold text-white bg-blue-600 rounded-md hover:bg-blue-700">åŒ¯å‡ºæœ¬æ—¥å ±å</button>
                    <button id="close-registrations-modal" class="ml-2 text-gray-500 hover:text-gray-800 text-2xl leading-none">&times;</button>
                </div>
            </div>
            <div id="registrations-list" class="max-h-[60vh] overflow-y-auto">
                <!-- å ±åè€…è³‡æ–™æœƒå‹•æ…‹æ’å…¥é€™è£¡ -->
            </div>
        </div>
    </div>

    <!-- å®¢æˆ¶è©³ç´°è³‡æ–™ Modal -->
    <div id="customer-details-modal" class="hidden modal-backdrop">
        <div class="modal-content bg-white w-11/12 md:max-w-2xl mx-auto rounded-lg shadow-xl p-6">
            <div class="flex justify-between items-center mb-4 border-b pb-3">
                <h3 id="customer-details-title" class="text-2xl font-bold">å®¢æˆ¶è©³ç´°è³‡æ–™</h3>
                <button id="close-customer-details-modal" class="text-gray-500 hover:text-gray-800 text-3xl leading-none">&times;</button>
            </div>
            <div id="customer-details-content" class="max-h-[70vh] overflow-y-auto">
                <!-- å®¢æˆ¶è³‡æ–™æœƒå‹•æ…‹æ’å…¥é€™è£¡ -->
            </div>
        </div>
    </div>
    
    <!-- ç®¡ç†å ±åä¾†æº Modal -->
    <div id="manage-sources-modal" class="hidden modal-backdrop">
        <div class="modal-content bg-white w-11/12 md:max-w-md mx-auto rounded-lg shadow-xl p-6">
             <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold">ç®¡ç†å ±åä¾†æº</h3>
                <button id="close-sources-modal" class="text-gray-500 hover:text-gray-800 text-2xl leading-none">&times;</button>
            </div>
            <div id="source-management-list" class="space-y-2 mb-4 max-h-60 overflow-y-auto">
                <!-- ä¾†æºåˆ—è¡¨ -->
            </div>
            <form id="add-source-form" class="flex space-x-2">
                <input type="text" id="new-source-name" placeholder="æ–°å¢ä¾†æºåç¨±..." class="flex-grow border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                <button type="submit" class="bg-blue-500 text-white px-4 py-2 rounded-md hover:bg-blue-600">æ–°å¢</button>
            </form>
        </div>
    </div>

    <!-- ç®¡ç†è¬›å¸« Modal -->
    <div id="manage-instructors-modal" class="hidden modal-backdrop">
        <div class="modal-content bg-white w-11/12 md:max-w-md mx-auto rounded-lg shadow-xl p-6">
             <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold">ç®¡ç†è¬›å¸«</h3>
                <button id="close-instructors-modal" class="text-gray-500 hover:text-gray-800 text-2xl leading-none">&times;</button>
            </div>
            <div id="instructor-management-list" class="space-y-2 mb-4 max-h-60 overflow-y-auto">
                <!-- è¬›å¸«åˆ—è¡¨ -->
            </div>
            <form id="add-instructor-form" class="flex space-x-2">
                <input type="text" id="new-instructor-name" placeholder="æ–°å¢è¬›å¸«åç¨±..." class="flex-grow border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                <button type="submit" class="bg-blue-500 text-white px-4 py-2 rounded-md hover:bg-blue-600">æ–°å¢</button>
            </form>
        </div>
    </div>

    <!-- æ¨™è¨» OOO Modal -->
    <div id="mark-ooo-modal" class="hidden modal-backdrop">
        <div class="modal-content bg-white w-11/12 md:max-w-md mx-auto rounded-lg shadow-xl p-6">
            <h3 class="text-xl font-bold mb-4">æ¨™è¨» Out of Office</h3>
            <p class="text-sm text-gray-600 mb-4">ç‚º <span id="ooo-date-display" class="font-semibold"></span> æ¨™è¨»ä¼‘å‡è¬›å¸«</p>
            <form id="ooo-form" class="space-y-4">
                <div>
                    <label for="ooo-instructor-select" class="block text-sm font-medium text-gray-700">é¸æ“‡è¬›å¸«</label>
                    <select id="ooo-instructor-select" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                        <!-- Instructor options will be injected here -->
                    </select>
                </div>
                <div class="mt-6 flex justify-end space-x-3">
                    <button type="button" id="cancel-ooo-form" class="bg-gray-200 text-gray-700 px-4 py-2 rounded-md hover:bg-gray-300">å–æ¶ˆ</button>
                    <button type="submit" class="bg-blue-500 text-white px-4 py-2 rounded-md hover:bg-blue-600">å„²å­˜</button>
                </div>
            </form>
        </div>
    </div>

    <!-- æ—¥æœŸé»æ“Šå¿«æ·é¸å–® Modal -->
    <div id="date-action-modal" class="hidden modal-backdrop">
        <div class="modal-content bg-white w-11/12 md:max-w-xs mx-auto rounded-lg shadow-xl p-6">
            <h3 class="text-lg font-bold mb-4" id="date-action-title"></h3>
            <div class="space-y-3">
                <button id="date-action-add-event" class="w-full text-left p-3 bg-blue-50 hover:bg-blue-100 rounded-md">ğŸ“… æ–°å¢æ´»å‹•</button>
                <button id="date-action-mark-ooo" class="w-full text-left p-3 bg-gray-50 hover:bg-gray-100 rounded-md">ğŸï¸ æ¨™è¨» OOO</button>
                 <button id="date-action-cancel" class="w-full text-center text-sm p-2 text-gray-600 hover:bg-gray-100 rounded-md mt-2">å–æ¶ˆ</button>
            </div>
        </div>
    </div>
    
    <!-- æ‰¹æ¬¡åŒ¯å…¥ Modal -->
    <div id="batch-import-modal" class="hidden modal-backdrop">
        <div class="modal-content bg-white w-11/12 md:max-w-2xl mx-auto rounded-lg shadow-xl p-6">
             <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold">æ‰¹æ¬¡åŒ¯å…¥è¨‚å–®</h3>
                <button id="close-batch-import-modal" class="text-gray-500 hover:text-gray-800 text-2xl leading-none">&times;</button>
            </div>
            <form id="batch-import-form">
                <div class="space-y-4">
                    <div>
                        <label for="batch-event-select" class="block text-sm font-medium text-gray-700">é¸æ“‡è¦åŒ¯å…¥çš„æ´»å‹•</label>
                        <select id="batch-event-select" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                            <!-- Event options will be injected here -->
                        </select>
                    </div>
                    <div>
                        <label for="batch-data-textarea" class="block text-sm font-medium text-gray-700">è²¼ä¸Šè¨‚å–®è³‡æ–™</label>
                        <p class="text-xs text-gray-500 mb-2">è«‹å¾ Excel æˆ– Google Sheets è¤‡è£½è³‡æ–™ï¼Œä¸¦ç¢ºä¿æ¬„ä½é †åºæ­£ç¢ºã€‚æ¯ä¸€è¡Œä»£è¡¨ä¸€ç­†è¨‚å–®ï¼Œæ¬„ä½é–“è«‹ç”¨ Tab åˆ†éš”ã€‚</p>
                        <div class="p-2 bg-gray-100 rounded text-xs text-gray-600">
                            <strong>æ ¼å¼:</strong> å§“å(Tab)é›»è©±(Tab)Email(Tab)èº«åˆ†è­‰(Tab)ç”Ÿæ—¥(YYYY-MM-DD)(Tab)è·æ¥­
                        </div>
                        <textarea id="batch-data-textarea" rows="10" required class="mt-2 block w-full border border-gray-300 rounded-md shadow-sm p-2 font-mono text-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" placeholder="ç‹å°æ˜	0912345678	ming@example.com..."></textarea>
                    </div>
                </div>
                <div class="mt-6 flex justify-end space-x-3">
                    <button type="button" id="cancel-batch-import-btn" class="bg-gray-200 text-gray-700 px-4 py-2 rounded-md hover:bg-gray-300">å–æ¶ˆ</button>
                    <button type="submit" class="bg-indigo-600 text-white px-4 py-2 rounded-md hover:bg-indigo-700">é–‹å§‹åŒ¯å…¥</button>
                </div>
            </form>
        </div>
    </div>


    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, addDoc, query, where, getDocs, setLogLevel, doc, updateDoc, serverTimestamp, deleteDoc, writeBatch } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- DOM å…ƒç´  ---
        const appDiv = document.getElementById('app');
        const calendarView = document.getElementById('calendar-view');
        const orderView = document.getElementById('order-view');
        const customerView = document.getElementById('customer-view');
        const showCalendarBtn = document.getElementById('show-calendar-btn');
        const showOrderBtn = document.getElementById('show-order-btn');
        const showCustomerBtn = document.getElementById('show-customer-btn');
        const addEventModal = document.getElementById('add-event-modal');
        const eventForm = document.getElementById('event-form');
        const cancelEventFormBtn = document.getElementById('cancel-event-form');
        const eventTitleInput = document.getElementById('event-title');
        const eventDateInput = document.getElementById('event-date');
        const eventIdInput = document.getElementById('event-id');
        const eventModalTitle = document.getElementById('event-modal-title');
        const deleteEventBtn = document.getElementById('delete-event-btn');
        const orderForm = document.getElementById('order-form');
        const eventSelectHidden = document.getElementById('event-select-hidden');
        const eventSearchInput = document.getElementById('event-search-input');
        const eventDropdownList = document.getElementById('event-dropdown-list');
        const viewRegistrationsModal = document.getElementById('view-registrations-modal');
        const closeRegistrationsModalBtn = document.getElementById('close-registrations-modal');
        const registrationsListDiv = document.getElementById('registrations-list');
        const registrationsTitle = document.getElementById('registrations-title');
        const addCustomFieldBtn = document.getElementById('add-custom-field-btn');
        const customFieldsContainer = document.getElementById('custom-fields-container');
        const customerListContainer = document.getElementById('customer-list-container');
        const customerSearchInput = document.getElementById('customer-search-input');
        const customerDetailsModal = document.getElementById('customer-details-modal');
        const closeCustomerDetailsModalBtn = document.getElementById('close-customer-details-modal');
        const customerDetailsTitle = document.getElementById('customer-details-title');
        const customerDetailsContent = document.getElementById('customer-details-content');
        const customerNameInput = document.getElementById('customer-name');
        const customerSuggestionsContainer = document.getElementById('customer-suggestions');
        const exportMonthBtn = document.getElementById('export-month-btn');
        const exportEventBtn = document.getElementById('export-event-btn');
        const exportDayFromModalBtn = document.getElementById('export-day-from-modal-btn');
        const editEventBtn = document.getElementById('edit-event-btn');
        const manageSourcesBtn = document.getElementById('manage-sources-btn');
        const manageSourcesModal = document.getElementById('manage-sources-modal');
        const closeSourcesModalBtn = document.getElementById('close-sources-modal');
        const addSourceForm = document.getElementById('add-source-form');
        const newSourceNameInput = document.getElementById('new-source-name');
        const sourceManagementList = document.getElementById('source-management-list');
        const registrationSourceContainer = document.getElementById('registration-source-container');
        const eventInstructorSelect = document.getElementById('event-instructor-select');
        const colorPaletteContainer = document.getElementById('color-palette');
        const eventColorInput = document.getElementById('event-color');
        const manageInstructorsBtn = document.getElementById('manage-instructors-btn');
        const manageInstructorsModal = document.getElementById('manage-instructors-modal');
        const closeInstructorsModalBtn = document.getElementById('close-instructors-modal');
        const instructorManagementList = document.getElementById('instructor-management-list');
        const addInstructorForm = document.getElementById('add-instructor-form');
        const newInstructorNameInput = document.getElementById('new-instructor-name');
        const markOooModal = document.getElementById('mark-ooo-modal');
        const oooForm = document.getElementById('ooo-form');
        const cancelOooFormBtn = document.getElementById('cancel-ooo-form');
        const oooInstructorSelect = document.getElementById('ooo-instructor-select');
        const oooDateDisplay = document.getElementById('ooo-date-display');
        const dateActionModal = document.getElementById('date-action-modal');
        const dateActionTitle = document.getElementById('date-action-title');
        const dateActionAddEventBtn = document.getElementById('date-action-add-event');
        const dateActionMarkOooBtn = document.getElementById('date-action-mark-ooo');
        const dateActionCancelBtn = document.getElementById('date-action-cancel');
        const batchImportBtn = document.getElementById('batch-import-btn');
        const batchImportModal = document.getElementById('batch-import-modal');
        const closeBatchImportModalBtn = document.getElementById('close-batch-import-modal');
        const cancelBatchImportBtn = document.getElementById('cancel-batch-import-btn');
        const batchImportForm = document.getElementById('batch-import-form');
        const batchEventSelect = document.getElementById('batch-event-select');
        const batchDataTextarea = document.getElementById('batch-data-textarea');


        // --- Firebase è¨­å®š ---
        let db, auth;
        let eventsCollection, registrationsCollection, customersCollection, registrationSourcesCollection, instructorsCollection, oooDaysCollection;
        let calendar; // FullCalendar å¯¦ä¾‹
        let isAppInitialized = false; // Flag to prevent multiple initializations
        let unsubscribeRegistrations = null; // ç”¨æ–¼å–æ¶ˆå ±ååˆ—è¡¨çš„å³æ™‚ç›£è½
        let eventsData = []; // å„²å­˜æ´»å‹•è³‡æ–™
        let registrationsData = []; // å„²å­˜å ±åè³‡æ–™
        let customersData = []; // å„²å­˜å®¢æˆ¶è³‡æ–™
        let registrationSourcesData = []; // å„²å­˜å ±åä¾†æºé¸é …
        let instructorsData = []; // å„²å­˜è¬›å¸«è³‡æ–™
        let oooDaysData = []; // å„²å­˜OOOè³‡æ–™
        let selectedDate = null; // å„²å­˜ä½¿ç”¨è€…é»æ“Šçš„æ—¥æœŸ

        const colorPalette = ['#3b82f6', '#10b981', '#ef4444', '#f97316', '#8b5cf6', '#ec4899']; // é è¨­é¡è‰²

        const firebaseConfig = {
            apiKey: "AIzaSyCObFRNQxxXzcG5XSsCHWM-RbSLFOAACYo",
            authDomain: "tphe-event-management.firebaseapp.com",
            projectId: "tphe-event-management",
            storageBucket: "tphe-event-management.appspot.com",
            messagingSenderId: "206814611445",
            appId: "1:206814611445:web:b2ff762359fd46816282bc",
            measurementId: "G-NHMWBP76TP"
        };
        
        const appId = firebaseConfig.projectId || 'default-app-id';
        
        async function main() {
            try {
                if (!firebaseConfig.apiKey || firebaseConfig.apiKey === "YOUR_API_KEY") {
                     throw new Error("Firebase è¨­å®šä¸æ­£ç¢ºï¼Œè«‹ä¾ç…§è¨»è§£æŒ‡ç¤ºè²¼ä¸Šæ‚¨çš„è¨­å®šã€‚");
                }
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                setLogLevel('debug'); // é–‹ç™¼æ™‚ä½¿ç”¨ï¼Œå¯çœ‹è¦‹è©³ç´°æ—¥èªŒ

                // --- èªè­‰ç›£è½ ---
                onAuthStateChanged(auth, user => {
                    if (user && !isAppInitialized) {
                        isAppInitialized = true; // Set flag
                        console.log("ä½¿ç”¨è€…å·²èªè­‰:", user.uid);
                        initializeAppData(user.uid);
                    }
                });

                // --- ç™»å…¥é‚è¼¯ ---
                // åœ¨å…¬é–‹ç¶²ç«™ä¸Šï¼Œæˆ‘å€‘å°‡ç›´æ¥ä½¿ç”¨åŒ¿åç™»å…¥
                await signInAnonymously(auth);

            } catch (e) {
                console.error("Firebase åˆå§‹åŒ–æˆ–ç™»å…¥å¤±æ•—:", e);
                 if (appDiv) {
                     if (e.message.includes("Firebase è¨­å®šä¸æ­£ç¢º")) {
                         appDiv.innerHTML = `<div class="bg-yellow-100 border-l-4 border-yellow-500 text-yellow-800 p-6 rounded-lg my-4" role="alert">
                            <h3 class="font-bold text-xl mb-2">ä¸‹ä¸€æ­¥ï¼šè«‹è¨­å®šæ‚¨çš„ Firebase é‡‘é‘°</h3>
                            <p class="mb-3">æ‡‰ç”¨ç¨‹å¼é‚„ç„¡æ³•é€£æ¥åˆ°é›²ç«¯è³‡æ–™åº«ï¼Œè«‹å®Œæˆæœ€å¾Œä¸€å€‹è¨­å®šæ­¥é©Ÿã€‚</p>
                            <ol class="list-decimal list-inside space-y-1">
                                <li>å‰å¾€æ‚¨çš„ <a href="https://console.firebase.google.com/" target="_blank" class="font-semibold underline hover:text-yellow-900">Firebase å°ˆæ¡ˆä¸»æ§å°</a>ã€‚</li>
                                <li>é»æ“Šå·¦ä¸Šè§’çš„âš™ï¸åœ–ç¤ºï¼Œé¸æ“‡ã€Œå°ˆæ¡ˆè¨­å®šã€ã€‚</li>
                                <li>åœ¨ã€Œæ‚¨çš„æ‡‰ç”¨ç¨‹å¼ã€å€å¡Šï¼Œè¤‡è£½ <code>firebaseConfig</code> è¨­å®šç‰©ä»¶ã€‚</li>
                                <li>å›åˆ°æœ¬é é¢ç¨‹å¼ç¢¼ï¼Œæ‰¾åˆ° <code>firebaseConfig</code> å¸¸æ•¸ã€‚</li>
                                <li>å°‡è¤‡è£½çš„å…§å®¹**å®Œæ•´å–ä»£**é ç•™ä½ç½®çš„ç¨‹å¼ç¢¼ã€‚</li>
                            </ol>
                            <p class="mt-4">å®Œæˆå¾Œå„²å­˜ä¸¦é‡æ–°æ•´ç†é é¢ï¼Œæ‚¨çš„æ‡‰ç”¨ç¨‹å¼å°±èƒ½æ­£å¸¸é‹ä½œäº†ï¼</p>
                        </div>`;
                    } else {
                        appDiv.innerHTML = `<div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative" role="alert">
                            <strong class="font-bold">éŒ¯èª¤!</strong>
                            <span class="block sm:inline">æ‡‰ç”¨ç¨‹å¼åˆå§‹åŒ–å¤±æ•—ï¼Œè«‹æª¢æŸ¥ä¸»æ§å°éŒ¯èª¤è¨Šæ¯ã€‚ (${e.message})</span>
                        </div>`;
                    }
                }
            }
        }

        main();

        function initializeAppData(userId) {
            // å®šç¾© Firestore collection è·¯å¾‘ - ç°¡åŒ–è·¯å¾‘ä»¥åŒ¹é…é è¨­å®‰å…¨è¦å‰‡
            eventsCollection = collection(db, "events");
            registrationsCollection = collection(db, "registrations");
            customersCollection = collection(db, "customers");
            registrationSourcesCollection = collection(db, "registrationSources");
            instructorsCollection = collection(db, "instructors");
            oooDaysCollection = collection(db, "oooDays");

            initializeCalendar();
            setupEventListeners();
            listenToData();
            checkAndSeedInitialSources(); 
            renderColorPalette(); 
        }

        // --- æœˆæ›†åˆå§‹åŒ– ---
        function initializeCalendar() {
            const calendarEl = document.getElementById('calendar');
            calendar = new FullCalendar.Calendar(calendarEl, {
                initialView: 'dayGridMonth',
                locale: 'zh-tw', // è¨­å®šç‚ºç¹é«”ä¸­æ–‡
                headerToolbar: {
                    left: 'prev,next today',
                    center: 'title',
                    right: 'dayGridMonth,dayGridWeek'
                },
                buttonText: {
                    today: 'ä»Šå¤©',
                    month: 'æœˆ',
                    week: 'é€±',
                    day: 'æ—¥'
                },
                eventOrder: 'order', // NEW: Sort events based on a custom property
                dateClick: function(info) {
                    selectedDate = info.dateStr;
                    dateActionTitle.textContent = selectedDate;
                    dateActionModal.classList.remove('hidden');
                },
                eventClick: function(info) {
                    if (info.event.extendedProps.type === 'ooo') return; // Ignore clicks on OOO events

                    const eventId = info.event.id;
                    const eventDate = info.event.startStr;
                    const event = eventsData.find(e => e.id === eventId);
                    const originalTitle = event?.title || '';
                    const instructor = event?.instructor || '';

                    // å°‡ eventId å’Œ date é™„åŠ åˆ°åŒ¯å‡ºæŒ‰éˆ•ä¸Š
                    exportEventBtn.dataset.eventId = eventId;
                    exportDayFromModalBtn.dataset.eventDate = eventDate;
                    editEventBtn.dataset.eventId = eventId; 
                    showRegistrations(eventId, originalTitle, instructor);
                }
            });
            calendar.render();
        }

        // --- Firestore è³‡æ–™ç›£è½ ---
        function listenToData() {
            onSnapshot(query(eventsCollection), (snapshot) => {
                eventsData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                updateCalendarDisplay();
                updateOrderFormDropdown();
            });

            onSnapshot(query(registrationsCollection), (snapshot) => {
                registrationsData = snapshot.docs.map(doc => ({id: doc.id, ...doc.data()}));
                updateCalendarDisplay();
            });

            onSnapshot(query(customersCollection), (snapshot) => {
                customersData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderCustomerList();
            });
            
            onSnapshot(query(registrationSourcesCollection), (snapshot) => {
                registrationSourcesData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderRegistrationSources();
            });

            onSnapshot(query(instructorsCollection), (snapshot) => {
                instructorsData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderInstructorsInModal();
                renderInstructorDropdowns();
            });
            
            onSnapshot(query(oooDaysCollection), (snapshot) => {
                oooDaysData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                updateCalendarDisplay();
            });
        }
        
        // --- åˆå§‹è³‡æ–™è¨­å®š ---
        async function checkAndSeedInitialSources() {
            const snapshot = await getDocs(registrationSourcesCollection);
            if (snapshot.empty) {
                console.log("æ­£åœ¨æ¤å…¥åˆå§‹å ±åä¾†æº...");
                const defaultSources = ['Line', 'FB', 'Accupass'];
                for (const sourceName of defaultSources) {
                    await addDoc(registrationSourcesCollection, { name: sourceName, createdAt: serverTimestamp() });
                }
            }
        }

        // --- ç•«é¢æ¸²æŸ“ ---

        function renderColorPalette() {
            colorPaletteContainer.innerHTML = colorPalette.map(color => `
                <div class="w-8 h-8 rounded-full cursor-pointer border-2" style="background-color: ${color};" data-color="${color}"></div>
            `).join('');
            
            const selectedColor = eventColorInput.value || colorPalette[0];
            const selectedDiv = colorPaletteContainer.querySelector(`div[data-color="${selectedColor}"]`);
            if (selectedDiv) {
                selectedDiv.classList.add('border-black', 'ring-2', 'ring-offset-2', 'ring-gray-800');
            } else {
                 const firstColorDiv = colorPaletteContainer.querySelector('div');
                 if(firstColorDiv) firstColorDiv.classList.add('border-black', 'ring-2', 'ring-offset-2', 'ring-gray-800');
            }
        }

        function renderRegistrationSources() {
            // æ¸²æŸ“è¨‚å–®åŒ¯å…¥é çš„å‹¾é¸æ¡†
            registrationSourceContainer.innerHTML = registrationSourcesData.map(source => `
                <div class="flex items-center">
                    <input id="source-${source.id}" name="sources" value="${source.name}" type="checkbox" class="h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
                    <label for="source-${source.id}" class="ml-2 block text-sm text-gray-900">${source.name}</label>
                </div>
            `).join('');

            // æ¸²æŸ“ç®¡ç†è¦–çª—çš„åˆ—è¡¨
            sourceManagementList.innerHTML = registrationSourcesData.map(source => `
                <div class="flex items-center justify-between p-2 bg-gray-100 rounded-md">
                    <span class="source-name" data-id="${source.id}">${source.name}</span>
                    <div class="space-x-2">
                        <button class="edit-source-btn text-xs text-blue-500 hover:underline" data-id="${source.id}" data-name="${source.name}">ç·¨è¼¯</button>
                        <button class="delete-source-btn text-xs text-red-500 hover:underline" data-id="${source.id}">åˆªé™¤</button>
                    </div>
                </div>
            `).join('');
        }
        
        function renderInstructorsInModal() {
            instructorManagementList.innerHTML = instructorsData.map(instructor => `
                <div class="flex items-center justify-between p-2 bg-gray-100 rounded-md">
                    <span>${instructor.name}</span>
                    <div class="space-x-2">
                         <button class="edit-instructor-btn text-xs text-blue-500 hover:underline" data-id="${instructor.id}" data-name="${instructor.name}">ç·¨è¼¯</button>
                         <button class="delete-instructor-btn text-xs text-red-500 hover:underline" data-id="${instructor.id}">åˆªé™¤</button>
                    </div>
                </div>
            `).join('');
        }

        function renderInstructorDropdowns() {
            const optionsHtml = instructorsData.map(i => `<option value="${i.name}">${i.name}</option>`).join('');
            eventInstructorSelect.innerHTML = `<option value="">ç„¡</option>${optionsHtml}`;
            oooInstructorSelect.innerHTML = `<option value="">è«‹é¸æ“‡</option>${optionsHtml}`;
        }
        
        function renderBatchEventSelect() {
            batchEventSelect.innerHTML = '<option value="">è«‹å…ˆé¸æ“‡ä¸€å€‹æ´»å‹•</option>';
            const sortedEvents = [...eventsData].sort((a, b) => new Date(a.date) - new Date(b.date));
            sortedEvents.forEach(event => {
                const option = document.createElement('option');
                option.value = event.id;
                option.textContent = `${event.date} - ${event.title}`;
                batchEventSelect.appendChild(option);
            });
        }


        function renderCustomerList() {
            const searchTerm = customerSearchInput.value.toLowerCase();
            const filteredCustomers = customersData.filter(c => {
                const nameMatch = c.customerName && c.customerName.toLowerCase().includes(searchTerm);
                const phoneMatch = c.primaryPhone && c.primaryPhone.toLowerCase().includes(searchTerm);
                return nameMatch || phoneMatch;
            });

            if(filteredCustomers.length === 0) {
                customerListContainer.innerHTML = '<p class="text-center text-gray-500 py-4">æ‰¾ä¸åˆ°å®¢æˆ¶æˆ–å°šç„¡å®¢æˆ¶è³‡æ–™ã€‚</p>';
                return;
            }
            
            customerListContainer.innerHTML = `
                <ul class="divide-y divide-gray-200">
                    ${filteredCustomers.map(c => `
                        <li class="p-4 hover:bg-gray-50 cursor-pointer" data-customer-id="${c.id}">
                            <div class="flex justify-between">
                                <p class="font-semibold text-gray-800">${c.customerName || 'æœªå‘½å'}</p>
                                <p class="text-sm text-gray-600">${c.primaryPhone || 'ç„¡é›»è©±'}</p>
                            </div>
                        </li>
                    `).join('')}
                </ul>
            `;
        }

        function updateCalendarDisplay() {
            if (!calendar) return;
            const registrationCounts = registrationsData.reduce((acc, reg) => {
                if (reg.eventId) {
                    acc[reg.eventId] = (acc[reg.eventId] || 0) + 1;
                }
                return acc;
            }, {});

            const eventsWithCounts = eventsData.map(event => {
                const count = registrationCounts[event.id] || 0;
                const displayTitle = event.instructor ? `[${event.instructor}] ${event.title} (${count}äºº)` : `${event.title} (${count}äºº)`;
                return {
                    id: event.id,
                    title: displayTitle,
                    start: event.date,
                    allDay: true,
                    backgroundColor: event.color || '#3b82f6', 
                    borderColor: event.color || '#3b82f6',
                    extendedProps: { type: 'activity', order: 1 } // Custom property for sorting
                };
            });
            
            const oooEvents = oooDaysData.map(day => ({
                id: `ooo-${day.id}`,
                title: `ä¼‘æ¯: ${day.instructorName}`,
                start: day.date,
                allDay: true,
                backgroundColor: '#d1d5db',
                borderColor: '#9ca3af',
                classNames: ['text-gray-700', 'cursor-not-allowed'],
                editable: false,
                extendedProps: { type: 'ooo', order: 2 } // Custom property for sorting
            }));
            
            calendar.removeAllEvents();
            calendar.addEventSource([...eventsWithCounts, ...oooEvents]);
        }

        function updateOrderFormDropdown(searchTerm = '') {
             const currentEventId = eventSelectHidden.value;
             eventDropdownList.innerHTML = '';
             let hasVisibleEvents = false;
             
             if (eventsData.length === 0) {
                eventDropdownList.innerHTML = '<div class="px-3 py-2 text-gray-500">å°šç„¡æ´»å‹•å¯é¸æ“‡</div>';
                return;
             }

             const sortedEvents = [...eventsData].sort((a, b) => new Date(a.date) - new Date(b.date));
             
             const groupedEvents = sortedEvents.reduce((acc, event) => {
                 const monthKey = event.date.substring(0, 7); // YYYY-MM
                 if (!acc[monthKey]) {
                     acc[monthKey] = [];
                 }
                 acc[monthKey].push(event);
                 return acc;
             }, {});

            const searchTermLower = searchTerm.toLowerCase();

             Object.keys(groupedEvents).sort().forEach(monthKey => {
                 const eventsInMonth = groupedEvents[monthKey].filter(event => {
                     const eventText = `${event.date} - ${event.title} ${event.instructor || ''}`.toLowerCase();
                     return eventText.includes(searchTermLower);
                 });

                 if (eventsInMonth.length > 0) {
                    hasVisibleEvents = true;
                    const date = new Date(`${monthKey}-01`);
                    const year = date.getFullYear();
                    const month = date.getMonth() + 1;
                    
                    const groupHeader = document.createElement('div');
                    groupHeader.className = 'px-3 py-2 bg-gray-100 text-sm font-bold text-gray-600 sticky top-0';
                    groupHeader.textContent = `${year}å¹´ ${month}æœˆ`;
                    eventDropdownList.appendChild(groupHeader);

                    eventsInMonth.forEach(event => {
                        const item = document.createElement('div');
                        item.className = 'px-3 py-2 hover:bg-blue-100 cursor-pointer';
                        item.textContent = `${event.date.substring(5)} - ${event.title}`;
                        item.dataset.eventId = event.id;
                        item.dataset.eventText = `${event.date} - ${event.title}`;
                        eventDropdownList.appendChild(item);
                    });
                 }
             });
             
             if (!hasVisibleEvents) {
                eventDropdownList.innerHTML = '<div class="px-3 py-2 text-gray-500">æ‰¾ä¸åˆ°ç¬¦åˆçš„æ´»å‹•</div>';
             }

              if (currentEventId) {
                const selectedEvent = eventsData.find(e => e.id === currentEventId);
                if (selectedEvent) {
                    eventSearchInput.value = `${selectedEvent.date} - ${selectedEvent.title}`;
                }
             }
        }
        
        // --- äº‹ä»¶è™•ç† ---
        async function showCustomerDetails(customerId) {
            const customer = customersData.find(c => c.id === customerId);
            if (!customer) return;

            customerDetailsTitle.textContent = `${customer.customerName || 'æœªå‘½å'} çš„è©³ç´°è³‡æ–™`;
            
            const customerRegistrations = registrationsData.filter(r => r.customerId === customerId);
            
            let eventHistoryHtml = '<p class="text-sm text-gray-500">å°šç„¡åƒåŠ æ´»å‹•ç´€éŒ„ã€‚</p>';
            if (customerRegistrations.length > 0) {
                eventHistoryHtml = `
                    <ul class="divide-y divide-gray-200">${customerRegistrations.map(reg => {
                        const event = eventsData.find(e => e.id === reg.eventId);
                        return `
                            <li class="py-2">
                                <p class="font-medium">${event ? event.title : 'æœªçŸ¥æ´»å‹•'}</p>
                                <p class="text-sm text-gray-500">æ—¥æœŸ: ${event ? event.date : 'N/A'}</p>
                            </li>`;
                    }).join('')}</ul>`;
            }

            customerDetailsContent.innerHTML = `
                <div class="space-y-6">
                    <div>
                        <div class="flex justify-between items-center mb-2">
                             <h4 class="text-lg font-bold">åŸºæœ¬è³‡æ–™</h4>
                             <div class="flex items-center space-x-4">
                                <button id="edit-customer-btn" data-customer-id="${customerId}" class="text-sm text-blue-600 hover:underline px-3 py-1">ç·¨è¼¯</button>
                                <button id="delete-customer-btn" data-customer-id="${customerId}" class="text-sm text-red-600 hover:underline px-3 py-1">åˆªé™¤å®¢æˆ¶</button>
                             </div>
                        </div>
                        
                        <!-- Display View -->
                        <div id="customer-info-display" class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                            <p><strong>å§“å:</strong> <span data-field="customerName">${customer.customerName || 'N/A'}</span></p>
                            <p><strong>é›»è©±:</strong> <span data-field="primaryPhone">${customer.primaryPhone || 'N/A'}</span></p>
                            <p><strong>Email:</strong> <span data-field="customerEmail">${customer.customerEmail || 'N/A'}</span></p>
                            <p><strong>èº«åˆ†è­‰:</strong> <span data-field="customerIdNumber">${customer.customerIdNumber || 'N/A'}</span></p>
                            <p><strong>ç”Ÿæ—¥:</strong> <span data-field="customerDob">${customer.customerDob || 'N/A'}</span></p>
                            <p><strong>è·æ¥­:</strong> <span data-field="customerOccupation">${customer.customerOccupation || 'N/A'}</span></p>
                        </div>

                        <!-- Edit Form View (hidden by default) -->
                        <form id="customer-info-form" class="hidden space-y-3" data-customer-id="${customerId}">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                                <div>
                                    <label class="block font-medium">å§“å</label>
                                    <input type="text" name="customerName" value="${customer.customerName || ''}" class="mt-1 p-2 w-full border border-gray-300 rounded-md">
                                </div>
                                <div>
                                    <label class="block font-medium">é›»è©±</label>
                                    <input type="tel" name="primaryPhone" value="${customer.primaryPhone || ''}" class="mt-1 p-2 w-full border border-gray-300 rounded-md">
                                </div>
                                <div>
                                    <label class="block font-medium">Email</label>
                                    <input type="email" name="customerEmail" value="${customer.customerEmail || ''}" class="mt-1 p-2 w-full border border-gray-300 rounded-md">
                                </div>
                                <div>
                                    <label class="block font-medium">èº«åˆ†è­‰</label>
                                    <input type="text" name="customerIdNumber" value="${customer.customerIdNumber || ''}" class="mt-1 p-2 w-full border border-gray-300 rounded-md">
                                </div>
                                <div>
                                    <label class="block font-medium">ç”Ÿæ—¥</label>
                                    <input type="date" name="customerDob" value="${customer.customerDob || ''}" class="mt-1 p-2 w-full border border-gray-300 rounded-md">
                                </div>
                                <div>
                                    <label class="block font-medium">è·æ¥­</label>
                                    <input type="text" name="customerOccupation" value="${customer.customerOccupation || ''}" class="mt-1 p-2 w-full border border-gray-300 rounded-md">
                                </div>
                            </div>
                            <div class="flex justify-end space-x-2 pt-2">
                                <button type="button" id="cancel-customer-edit-btn" class="bg-gray-200 text-gray-700 px-4 py-2 text-sm rounded-md hover:bg-gray-300">å–æ¶ˆ</button>
                                <button type="submit" id="save-customer-edit-btn" class="bg-blue-600 text-white px-4 py-2 text-sm rounded-md hover:bg-blue-700">å„²å­˜è®Šæ›´</button>
                            </div>
                        </form>
                    </div>
                    <div>
                        <h4 class="text-lg font-bold mb-2">å‚™è¨»</h4>
                        <textarea id="customer-notes-textarea" class="w-full border border-gray-300 rounded-md shadow-sm p-2 text-sm" rows="4">${customer.notes || ''}</textarea>
                        <button id="save-customer-notes-btn" data-customer-id="${customerId}" class="mt-2 bg-blue-500 text-white px-4 py-2 text-sm rounded-md hover:bg-blue-600">å„²å­˜å‚™è¨»</button>
                    </div>
                    <div>
                        <h4 class="text-lg font-bold mb-2">åƒåŠ éçš„æ´»å‹•</h4>
                        ${eventHistoryHtml}
                    </div>
                </div>
            `;

            customerDetailsModal.classList.remove('hidden');
        }

        async function showRegistrations(eventId, eventTitle, instructor) {
            const titleText = instructor ? `ã€Œ${eventTitle}ã€ by ${instructor}` : `ã€Œ${eventTitle}ã€çš„å ±ååˆ—è¡¨`;
            registrationsTitle.textContent = titleText;
            registrationsListDiv.innerHTML = '<p class="text-center text-gray-500">è®€å–ä¸­...</p>';
            viewRegistrationsModal.classList.remove('hidden');

            if (unsubscribeRegistrations) unsubscribeRegistrations();

            try {
                const q = query(registrationsCollection, where("eventId", "==", eventId));
                unsubscribeRegistrations = onSnapshot(q, (querySnapshot) => {
                    if (querySnapshot.empty) {
                        registrationsListDiv.innerHTML = '<p class="text-center text-gray-500">ç›®å‰å°šç„¡å ±åè³‡æ–™ã€‚</p>';
                        return;
                    }
                    let notCheckedInHtml = '<div><h4 class="text-md font-semibold text-gray-700 mb-2 border-b pb-2">æœªå ±åˆ°</h4><ul class="space-y-3">';
                    let checkedInHtml = '<div class="mt-6"><h4 class="text-md font-semibold text-gray-700 mb-2 border-b pb-2">å·²å ±åˆ°</h4><ul class="space-y-3">';
                    let notCheckedInCount = 0;
                    let checkedInCount = 0;
                    querySnapshot.forEach(doc => {
                        const data = doc.data();
                        let customFieldsHtml = '';
                        if (data.customFields && typeof data.customFields === 'object') {
                            for (const [key, value] of Object.entries(data.customFields)) {
                                if (key && value) {
                                     customFieldsHtml += `<p class="text-sm text-gray-500 col-span-1 sm:col-span-2 capitalize">${key}: <span class="font-medium text-gray-700">${value}</span></p>`;
                                }
                            }
                        }
                        
                        let sourcesHtml = '';
                        if (data.sources && Array.isArray(data.sources) && data.sources.length > 0) {
                            sourcesHtml = `<div class="col-span-1 sm:col-span-2 flex flex-wrap gap-2 mt-2">
                                ${data.sources.map(s => `<span class="text-xs bg-gray-200 text-gray-700 px-2 py-1 rounded-full">${s}</span>`).join('')}
                            </div>`;
                        }

                        const itemHtml = `
                            <li class="p-4 bg-gray-50 rounded-lg border border-gray-200">
                                <div class="flex items-start space-x-4">
                                    <input type="checkbox" data-doc-id="${doc.id}" class="check-in-box h-6 w-6 text-blue-600 border-gray-300 rounded focus:ring-blue-500 mt-1 flex-shrink-0" ${data.isCheckedIn ? 'checked' : ''}>
                                    <div class="flex-1 grid grid-cols-1 sm:grid-cols-2 gap-x-4 gap-y-1">
                                        <div class="col-span-1 sm:col-span-2 mb-1">
                                            <p class="text-lg font-bold text-gray-800">${data.customerName || 'æœªå‘½å'}</p>
                                        </div>
                                        <p class="text-sm text-gray-500">èº«åˆ†è­‰: <span class="font-medium text-gray-700">${data.customerIdNumber || 'N/A'}</span></p>
                                        <p class="text-sm text-gray-500">ç”Ÿæ—¥: <span class="font-medium text-gray-700">${data.customerDob || 'N/A'}</span></p>
                                        <p class="text-sm text-gray-500">é›»è©±: <span class="font-medium text-gray-700">${data.customerPhone || 'N/A'}</span></p>
                                        <p class="text-sm text-gray-500">è·æ¥­: <span class="font-medium text-gray-700">${data.customerOccupation || 'N/A'}</span></p>
                                        ${data.customerEmail ? `<p class="text-sm text-gray-500 col-span-1 sm:col-span-2">Email: <span class="font-medium text-gray-700">${data.customerEmail}</span></p>` : ''}
                                        ${customFieldsHtml}
                                        ${data.addonTransport ? `<div class="col-span-1 sm:col-span-2 mt-2 pt-2 border-t border-gray-200"><p class="text-sm text-green-600 font-semibold">âœ“ å·²åŠ è³¼äº¤é€šæ¥é€</p></div>` : ''}
                                        ${sourcesHtml}
                                    </div>
                                </div>
                            </li>`;
                        if (data.isCheckedIn) {
                            checkedInCount++;
                            checkedInHtml += itemHtml;
                        } else {
                            notCheckedInCount++;
                            notCheckedInHtml += itemHtml;
                        }
                    });
                    notCheckedInHtml += '</ul></div>';
                    checkedInHtml += '</ul></div>';
                    if (notCheckedInCount === 0) notCheckedInHtml = '<div><h4 class="text-md font-semibold text-gray-700 mb-2 border-b pb-2">æœªå ±åˆ°</h4><p class="text-sm text-gray-500 mt-2">æ‰€æœ‰äººéƒ½å·²å ±åˆ°ï¼</p></div>';
                    if (checkedInCount === 0) checkedInHtml = '<div class="mt-6"><h4 class="text-md font-semibold text-gray-700 mb-2 border-b pb-2">å·²å ±åˆ°</h4><p class="text-sm text-gray-500 mt-2">å°šç„¡äººå ±åˆ°ã€‚</p></div>';
                    registrationsListDiv.innerHTML = notCheckedInHtml + checkedInHtml;
                });
            } catch (error) {
                console.error("è®€å–å ±åè³‡æ–™å¤±æ•—:", error);
                registrationsListDiv.innerHTML = '<p class="text-center text-red-500">è®€å–è³‡æ–™å¤±æ•—ã€‚</p>';
            }
        }
        
        async function handleEventFormSubmit(e) {
            e.preventDefault();
            const eventId = eventIdInput.value;
            const title = eventTitleInput.value.trim();
            const date = eventDateInput.value;
            const instructor = eventInstructorSelect.value;
            const color = eventColorInput.value;

            if (!title || !date) return;

            const eventData = { title, date, instructor, color };

            try {
                if (eventId) {
                    // Update existing event
                    const eventRef = doc(eventsCollection, eventId);
                    await updateDoc(eventRef, eventData);
                } else {
                    // Add new event
                    await addDoc(eventsCollection, eventData);
                }
                eventForm.reset();
                addEventModal.classList.add('hidden');
            } catch (error) {
                console.error("å„²å­˜æ´»å‹•å¤±æ•—:", error);
            }
        }

        async function handleAddOrder(e) {
            e.preventDefault();
            const formData = new FormData(orderForm);
            const data = Object.fromEntries(formData.entries());

            if (!data.eventId) { 
                alert("è«‹å…ˆé¸æ“‡ä¸€å€‹æ´»å‹•ï¼");
                return; 
            }
            
            let customerId;
            const phone = data.customerPhone.trim();

            if (phone) {
                 const q = query(customersCollection, where("primaryPhone", "==", phone));
                 const querySnapshot = await getDocs(q);
                 if (querySnapshot.empty) {
                     // æ–°å®¢æˆ¶
                     const newCustomerRef = await addDoc(customersCollection, {
                         primaryPhone: phone,
                         customerName: data.customerName || '',
                         customerEmail: data.customerEmail || '',
                         customerIdNumber: data.customerIdNumber || '',
                         customerDob: data.customerDob || '',
                         customerOccupation: data.customerOccupation || '',
                         notes: '',
                         createdAt: serverTimestamp(),
                         lastUpdatedAt: serverTimestamp(),
                     });
                     customerId = newCustomerRef.id;
                 } else {
                     // ç¾æœ‰å®¢æˆ¶
                     const customerDoc = querySnapshot.docs[0];
                     customerId = customerDoc.id;
                     // å¯é¸æ“‡æ€§æ›´æ–°å®¢æˆ¶è³‡æ–™
                     await updateDoc(doc(customersCollection, customerId), {
                         customerName: data.customerName || customerDoc.data().customerName,
                         customerEmail: data.customerEmail || customerDoc.data().customerEmail,
                         lastUpdatedAt: serverTimestamp(),
                     });
                 }
            }

            const customFields = {};
            customFieldsContainer.querySelectorAll('.custom-field-group').forEach(group => {
                const key = group.querySelector('input[name="custom-key"]').value.trim();
                const value = group.querySelector('input[name="custom-value"]').value.trim();
                if (key && value) customFields[key] = value;
            });
            
            // è™•ç†å ±åä¾†æº
            const sources = [];
            orderForm.querySelectorAll('input[name="sources"]:checked').forEach(checkbox => {
                sources.push(checkbox.value);
            });

            try {
                await addDoc(registrationsCollection, {
                    eventId: data.eventId,
                    customerId: customerId || null, // é—œè¯å®¢æˆ¶ ID
                    customerName: data.customerName || '',
                    customerPhone: data.customerPhone || '',
                    customerEmail: data.customerEmail || '',
                    customerIdNumber: data.customerIdNumber || '',
                    customerDob: data.customerDob || '',
                    customerOccupation: data.customerOccupation || '',
                    addonTransport: !!data.addonTransport,
                    customFields: customFields,
                    sources: sources, // æ–°å¢ä¾†æºæ¬„ä½
                    isCheckedIn: false,
                    createdAt: new Date()
                });
                orderForm.reset();
                eventSearchInput.value = ''; // Clear search input
                eventSelectHidden.value = '';
                customFieldsContainer.innerHTML = '';
                customerSuggestionsContainer.classList.add('hidden');
            } catch (error) {
                console.error("æ–°å¢è¨‚å–®å¤±æ•—:", error);
            }
        }
        
        // --- Helper: åŒ¯å‡º CSV ---
        function exportToCsv(filename, rows) {
            if (!rows || rows.length === 0) {
                console.warn("æ²’æœ‰å¯åŒ¯å‡ºçš„è³‡æ–™ã€‚");
                // å¯ä»¥åœ¨æ­¤è™•é¡¯ç¤ºä¸€å€‹æº«å’Œçš„æç¤ºè¨Šæ¯çµ¦ä½¿ç”¨è€…
                return;
            }

            const processRow = (row) => {
                return row.map(val => {
                    const str = String(val == null ? '' : val);
                    if (str.includes(',') || str.includes('"') || str.includes('\n')) {
                        return `"${str.replace(/"/g, '""')}"`;
                    }
                    return str;
                }).join(',');
            };

            const headers = Object.keys(rows[0]);
            let csvContent = processRow(headers) + '\r\n';

            rows.forEach(row => {
                const values = headers.map(header => row[header]);
                csvContent += processRow(values) + '\r\n';
            });
            
            // åŠ ä¸Š BOM ä¾†ç¢ºä¿ Excel èƒ½æ­£ç¢ºè®€å– UTF-8
            const blob = new Blob(['\uFEFF' + csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            if (link.download !== undefined) {
                const url = URL.createObjectURL(blob);
                link.setAttribute("href", url);
                link.setAttribute("download", filename);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }
        }

        // --- äº‹ä»¶ç›£è½å™¨è¨­å®š ---
        function setupEventListeners() {
            function setActiveButton(activeBtn) {
                [showCalendarBtn, showOrderBtn, showCustomerBtn].forEach(btn => {
                    if (btn === activeBtn) {
                        btn.classList.replace('bg-gray-200', 'bg-blue-500');
                        btn.classList.replace('text-gray-700', 'text-white');
                    } else {
                        btn.classList.replace('bg-blue-500', 'bg-gray-200');
                        btn.classList.replace('text-white', 'text-gray-700');
                    }
                });
            }

            function showView(activeView) {
                 [calendarView, orderView, customerView].forEach(view => {
                    if (view === activeView) {
                        view.classList.remove('hidden');
                    } else {
                        view.classList.add('hidden');
                    }
                });
            }

            showCalendarBtn.addEventListener('click', () => {
                showView(calendarView);
                setActiveButton(showCalendarBtn);
                calendar.render();
            });

            showOrderBtn.addEventListener('click', () => {
                showView(orderView);
                setActiveButton(showOrderBtn);
            });
            
            showCustomerBtn.addEventListener('click', () => {
                showView(customerView);
                setActiveButton(showCustomerBtn);
            });

            // --- Event Search Dropdown Logic ---
            eventSearchInput.addEventListener('click', () => {
                eventDropdownList.classList.toggle('hidden');
                if(!eventDropdownList.classList.contains('hidden')) {
                     eventSearchInput.removeAttribute('readonly');
                     eventSearchInput.value = ''; // Clear on open
                     updateOrderFormDropdown(''); // Show all
                } else {
                     eventSearchInput.setAttribute('readonly', true);
                }
            });

             eventSearchInput.addEventListener('input', () => {
                updateOrderFormDropdown(eventSearchInput.value);
            });

            eventDropdownList.addEventListener('click', (e) => {
                const target = e.target.closest('[data-event-id]');
                if(target) {
                    eventSelectHidden.value = target.dataset.eventId;
                    eventSearchInput.value = target.dataset.eventText;
                    eventDropdownList.classList.add('hidden');
                    eventSearchInput.setAttribute('readonly', true);
                }
            });

            // --- è‡ªå‹•å®Œæˆæœå°‹åŠŸèƒ½ ---
            customerNameInput.addEventListener('input', () => {
                const searchTerm = customerNameInput.value.trim().toLowerCase();
                if (searchTerm.length < 1) {
                    customerSuggestionsContainer.classList.add('hidden');
                    return;
                }

                const filteredCustomers = customersData.filter(c => {
                    const nameMatch = c.customerName && c.customerName.toLowerCase().includes(searchTerm);
                    const phoneMatch = c.primaryPhone && c.primaryPhone.includes(searchTerm);
                    return nameMatch || phoneMatch;
                }).slice(0, 10);

                if (filteredCustomers.length > 0) {
                    customerSuggestionsContainer.innerHTML = `
                        <ul class="divide-y divide-gray-100">
                            ${filteredCustomers.map(c => `
                                <li class="p-2 cursor-pointer hover:bg-blue-100" data-customer-id="${c.id}">
                                    <p class="font-semibold text-sm">${c.customerName || 'N/A'}</p>
                                    <p class="text-xs text-gray-500">${c.primaryPhone || 'N/A'}</p>
                                </li>
                            `).join('')}
                        </ul>
                    `;
                    customerSuggestionsContainer.classList.remove('hidden');
                } else {
                    customerSuggestionsContainer.classList.add('hidden');
                }
            });

            customerSuggestionsContainer.addEventListener('click', (e) => {
                const selectedLi = e.target.closest('li[data-customer-id]');
                if (selectedLi) {
                    const customerId = selectedLi.dataset.customerId;
                    const customer = customersData.find(c => c.id === customerId);
                    if (customer) {
                        orderForm.elements['customerName'].value = customer.customerName || '';
                        orderForm.elements['customerPhone'].value = customer.primaryPhone || '';
                        orderForm.elements['customerEmail'].value = customer.customerEmail || '';
                        orderForm.elements['customerIdNumber'].value = customer.customerIdNumber || '';
                        orderForm.elements['customerDob'].value = customer.customerDob || '';
                        orderForm.elements['customerOccupation'].value = customer.customerOccupation || '';
                    }
                    customerSuggestionsContainer.classList.add('hidden');
                }
            });

            // é»æ“Šé é¢å…¶ä»–åœ°æ–¹ï¼Œéš±è—å»ºè­°åˆ—è¡¨
            document.addEventListener('click', (e) => {
                if (!customerNameInput.contains(e.target) && !customerSuggestionsContainer.contains(e.target)) {
                    customerSuggestionsContainer.classList.add('hidden');
                }
                if (!eventSearchInput.contains(e.target) && !eventDropdownList.contains(e.target)) {
                    eventDropdownList.classList.add('hidden');
                    eventSearchInput.setAttribute('readonly', true);
                }
            });


            customerSearchInput.addEventListener('input', renderCustomerList);

            customerListContainer.addEventListener('click', (e) => {
                const listItem = e.target.closest('li[data-customer-id]');
                if (listItem) {
                    showCustomerDetails(listItem.dataset.customerId);
                }
            });

            // --- åŒ¯å‡ºåŠŸèƒ½äº‹ä»¶ç›£è½ ---

            exportEventBtn.addEventListener('click', () => {
                const eventId = exportEventBtn.dataset.eventId;
                if (!eventId) return;

                const event = eventsData.find(e => e.id === eventId);
                const eventRegistrations = registrationsData.filter(r => r.eventId === eventId);
                
                if (eventRegistrations.length === 0) { return; }

                const dataToExport = eventRegistrations.map(reg => ({
                    'æ´»å‹•æ¨™é¡Œ': event.title,
                    'æ´»å‹•æ—¥æœŸ': event.date,
                    'å ±åè€…å§“å': reg.customerName,
                    'è¯çµ¡é›»è©±': reg.customerPhone,
                    'é›»å­éƒµä»¶': reg.customerEmail,
                    'èº«åˆ†è­‰å­—è™Ÿ': reg.customerIdNumber,
                    'å‡ºç”Ÿå¹´æœˆæ—¥': reg.customerDob,
                    'è·æ¥­': reg.customerOccupation,
                    'äº¤é€šæ¥é€': reg.addonTransport ? 'æ˜¯' : 'å¦',
                    'å ±åä¾†æº': (reg.sources || []).join(', '),
                    'è‡ªè¨‚æ¬„ä½': JSON.stringify(reg.customFields || {}),
                    'æ˜¯å¦å ±åˆ°': reg.isCheckedIn ? 'æ˜¯' : 'å¦'
                }));

                exportToCsv(`${event.title}_å ±åè³‡æ–™.csv`, dataToExport);
            });

            exportMonthBtn.addEventListener('click', () => {
                const calendarDate = calendar.getDate();
                const year = calendarDate.getFullYear();
                const month = calendarDate.getMonth();

                const firstDayOfMonth = new Date(year, month, 1);
                const lastDayOfMonth = new Date(year, month + 1, 0);

                const eventIdsThisMonth = eventsData
                    .filter(event => {
                        const eventDate = new Date(event.date);
                        return eventDate >= firstDayOfMonth && eventDate <= lastDayOfMonth;
                    })
                    .map(event => event.id);

                const registrationsThisMonth = registrationsData.filter(reg => eventIdsThisMonth.includes(reg.eventId));
                
                if (registrationsThisMonth.length === 0) { return; }

                const dataToExport = registrationsThisMonth.map(reg => {
                    const event = eventsData.find(e => e.id === reg.eventId) || {};
                    return {
                        'æ´»å‹•æ¨™é¡Œ': event.title,
                        'æ´»å‹•æ—¥æœŸ': event.date,
                        'å ±åè€…å§“å': reg.customerName,
                        'è¯çµ¡é›»è©±': reg.customerPhone,
                        'é›»å­éƒµä»¶': reg.customerEmail,
                        'èº«åˆ†è­‰å­—è™Ÿ': reg.customerIdNumber,
                        'å‡ºç”Ÿå¹´æœˆæ—¥': reg.customerDob,
                        'è·æ¥­': reg.customerOccupation,
                        'äº¤é€šæ¥é€': reg.addonTransport ? 'æ˜¯' : 'å¦',
                        'å ±åä¾†æº': (reg.sources || []).join(', '),
                        'è‡ªè¨‚æ¬„ä½': JSON.stringify(reg.customFields || {}),
                        'æ˜¯å¦å ±åˆ°': reg.isCheckedIn ? 'æ˜¯' : 'å¦'
                    };
                });
                
                exportToCsv(`å ±åè³‡æ–™_${year}-${String(month + 1).padStart(2, '0')}.csv`, dataToExport);
            });

            exportDayFromModalBtn.addEventListener('click', () => {
                const eventDate = exportDayFromModalBtn.dataset.eventDate;
                if (!eventDate) return;

                const eventIdsOnDate = eventsData
                    .filter(event => event.date === eventDate)
                    .map(event => event.id);
                
                if (eventIdsOnDate.length === 0) { return; }

                const registrationsOnDate = registrationsData.filter(reg => eventIdsOnDate.includes(reg.eventId));

                if (registrationsOnDate.length === 0) { return; }

                const dataToExport = registrationsOnDate.map(reg => {
                    const event = eventsData.find(e => e.id === reg.eventId) || {};
                    return {
                        'æ´»å‹•æ¨™é¡Œ': event.title,
                        'æ´»å‹•æ—¥æœŸ': event.date,
                        'å ±åè€…å§“å': reg.customerName,
                        'è¯çµ¡é›»è©±': reg.customerPhone,
                        'é›»å­éƒµä»¶': reg.customerEmail,
                        'èº«åˆ†è­‰å­—è™Ÿ': reg.customerIdNumber,
                        'å‡ºç”Ÿå¹´æœˆæ—¥': reg.customerDob,
                        'è·æ¥­': reg.customerOccupation,
                        'äº¤é€šæ¥é€': reg.addonTransport ? 'æ˜¯' : 'å¦',
                        'å ±åä¾†æº': (reg.sources || []).join(', '),
                        'è‡ªè¨‚æ¬„ä½': JSON.stringify(reg.customFields || {}),
                        'æ˜¯å¦å ±åˆ°': reg.isCheckedIn ? 'æ˜¯' : 'å¦'
                    };
                });

                exportToCsv(`å ±åè³‡æ–™_${eventDate}.csv`, dataToExport);
            });

            editEventBtn.addEventListener('click', () => {
                const eventId = editEventBtn.dataset.eventId;
                const event = eventsData.find(e => e.id === eventId);
                if (event) {
                    eventForm.reset();
                    eventModalTitle.textContent = "ç·¨è¼¯æ´»å‹•";
                    eventIdInput.value = event.id;
                    eventDateInput.value = event.date;
                    eventTitleInput.value = event.title;
                    eventInstructorSelect.value = event.instructor || '';
                    eventColorInput.value = event.color || colorPalette[0];
                    deleteEventBtn.classList.remove('hidden');
                    renderColorPalette();
                    addEventModal.classList.remove('hidden');
                    // è‡ªå‹•é—œé–‰å¾Œæ–¹çš„å ±ååˆ—è¡¨è¦–çª—ï¼Œå„ªåŒ–é«”é©—
                    viewRegistrationsModal.classList.add('hidden');
                }
            });

            deleteEventBtn.addEventListener('click', async () => {
                const eventId = eventIdInput.value;
                if (!eventId) return;

                if (confirm('ç¢ºå®šè¦åˆªé™¤é€™å€‹æ´»å‹•å—ï¼Ÿ\næ‰€æœ‰ç›¸é—œçš„å ±åè³‡æ–™å°‡æœƒä¸€ä½µæ°¸ä¹…åˆªé™¤ï¼')) {
                    try {
                        // Find all registrations for this event
                        const q = query(registrationsCollection, where("eventId", "==", eventId));
                        const registrationsSnapshot = await getDocs(q);

                        const batch = writeBatch(db);

                        // Delete all related registrations
                        registrationsSnapshot.forEach(doc => {
                            batch.delete(doc.ref);
                        });

                        // Delete the event itself
                        batch.delete(doc(eventsCollection, eventId));

                        await batch.commit();

                        addEventModal.classList.add('hidden');
                        viewRegistrationsModal.classList.add('hidden');
                    } catch (error) {
                        console.error("åˆªé™¤æ´»å‹•å¤±æ•—:", error);
                    }
                }
            });

            cancelEventFormBtn.addEventListener('click', () => addEventModal.classList.add('hidden'));
            closeRegistrationsModalBtn.addEventListener('click', () => {
                viewRegistrationsModal.classList.add('hidden');
                if (unsubscribeRegistrations) {
                    unsubscribeRegistrations();
                    unsubscribeRegistrations = null;
                }
            });
            closeCustomerDetailsModalBtn.addEventListener('click', () => customerDetailsModal.classList.add('hidden'));
            
            // --- å ±åä¾†æºç®¡ç† Modal ---
            manageSourcesBtn.addEventListener('click', () => manageSourcesModal.classList.remove('hidden'));
            closeSourcesModalBtn.addEventListener('click', () => manageSourcesModal.classList.add('hidden'));

            addSourceForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const newName = newSourceNameInput.value.trim();
                if (newName) {
                    try {
                        await addDoc(registrationSourcesCollection, { name: newName, createdAt: serverTimestamp() });
                        newSourceNameInput.value = '';
                    } catch (error) {
                        console.error("æ–°å¢ä¾†æºå¤±æ•—:", error);
                    }
                }
            });

            sourceManagementList.addEventListener('click', async (e) => {
                const target = e.target;
                const id = target.dataset.id;
                
                if (target.classList.contains('delete-source-btn')) {
                    if (id && confirm('ç¢ºå®šè¦åˆªé™¤é€™å€‹ä¾†æºå—ï¼Ÿ')) {
                        try {
                            await deleteDoc(doc(registrationSourcesCollection, id));
                        } catch (error) {
                            console.error("åˆªé™¤ä¾†æºå¤±æ•—:", error);
                        }
                    }
                }

                if (target.classList.contains('edit-source-btn')) {
                    const currentName = target.dataset.name;
                    const newName = prompt('è«‹è¼¸å…¥æ–°çš„ä¾†æºåç¨±:', currentName);
                    if (newName && newName.trim() !== "" && newName.trim() !== currentName) {
                        try {
                            await updateDoc(doc(registrationSourcesCollection, id), { name: newName.trim() });
                        } catch (error) {
                            console.error("ç·¨è¼¯ä¾†æºå¤±æ•—:", error);
                        }
                    }
                }
            });

             // --- è¬›å¸«ç®¡ç† Modal ---
            manageInstructorsBtn.addEventListener('click', () => manageInstructorsModal.classList.remove('hidden'));
            closeInstructorsModalBtn.addEventListener('click', () => manageInstructorsModal.classList.add('hidden'));
            
            addInstructorForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const newName = newInstructorNameInput.value.trim();
                if (newName) {
                    try {
                        await addDoc(instructorsCollection, { name: newName, createdAt: serverTimestamp() });
                        newInstructorNameInput.value = '';
                    } catch (error) {
                        console.error("æ–°å¢è¬›å¸«å¤±æ•—:", error);
                    }
                }
            });

            instructorManagementList.addEventListener('click', async (e) => {
                const target = e.target;
                const id = target.dataset.id;
                if(target.classList.contains('delete-instructor-btn')) {
                    if (id && confirm('ç¢ºå®šè¦åˆªé™¤é€™ä½è¬›å¸«å—ï¼Ÿ')) {
                        try {
                            await deleteDoc(doc(instructorsCollection, id));
                        } catch (error) { console.error("åˆªé™¤è¬›å¸«å¤±æ•—:", error); }
                    }
                }
                 if (target.classList.contains('edit-instructor-btn')) {
                    const currentName = target.dataset.name;
                    const newName = prompt('è«‹è¼¸å…¥æ–°çš„è¬›å¸«åç¨±:', currentName);
                    if (newName && newName.trim() !== "" && newName.trim() !== currentName) {
                        try {
                            await updateDoc(doc(instructorsCollection, id), { name: newName.trim() });
                        } catch (error) { console.error("ç·¨è¼¯è¬›å¸«å¤±æ•—:", error); }
                    }
                }
            });
            
            // --- OOO Modal ---
            dateActionAddEventBtn.addEventListener('click', () => {
                dateActionModal.classList.add('hidden');
                eventForm.reset();
                eventModalTitle.textContent = "æ–°å¢æ´»å‹•";
                eventIdInput.value = '';
                eventDateInput.value = selectedDate;
                deleteEventBtn.classList.add('hidden');
                eventColorInput.value = colorPalette[0];
                renderColorPalette();
                addEventModal.classList.remove('hidden');
            });
            
            dateActionMarkOooBtn.addEventListener('click', () => {
                dateActionModal.classList.add('hidden');
                oooDateDisplay.textContent = selectedDate;
                markOooModal.classList.remove('hidden');
            });
            
            dateActionCancelBtn.addEventListener('click', () => {
                 dateActionModal.classList.add('hidden');
            });


            cancelOooFormBtn.addEventListener('click', () => markOooModal.classList.add('hidden'));

            oooForm.addEventListener('submit', async(e) => {
                e.preventDefault();
                const instructorName = oooInstructorSelect.value;
                const date = selectedDate;
                if(instructorName && date) {
                    try {
                        await addDoc(oooDaysCollection, { instructorName, date });
                        oooForm.reset();
                        markOooModal.classList.add('hidden');
                    } catch (error) {
                        console.error("å„²å­˜OOOæ—¥æœŸå¤±æ•—:", error);
                    }
                }
            });

            // --- æ‰¹æ¬¡åŒ¯å…¥ Modal ---
            batchImportBtn.addEventListener('click', () => {
                batchImportForm.reset();
                renderBatchEventSelect();
                batchImportModal.classList.remove('hidden');
            });

            closeBatchImportModalBtn.addEventListener('click', () => batchImportModal.classList.add('hidden'));
            cancelBatchImportBtn.addEventListener('click', () => batchImportModal.classList.add('hidden'));

            batchImportForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const eventId = batchEventSelect.value;
                const data = batchDataTextarea.value.trim();

                if (!eventId || !data) {
                    alert("è«‹é¸æ“‡æ´»å‹•ä¸¦è²¼ä¸Šè³‡æ–™ï¼");
                    return;
                }
                
                const lines = data.split('\n').filter(line => line.trim() !== '');
                if(lines.length === 0) return;

                const batch = writeBatch(db);

                try {
                    for (const line of lines) {
                        const [name, phone, email, idNumber, dob, occupation] = line.split('\t');
                        const trimmedPhone = phone ? phone.trim() : '';

                        let customerId = null;

                        if(trimmedPhone) {
                            const q = query(customersCollection, where("primaryPhone", "==", trimmedPhone));
                            const snapshot = await getDocs(q);
                            if(snapshot.empty) {
                                const newCustomerRef = doc(customersCollection);
                                batch.set(newCustomerRef, {
                                    primaryPhone: trimmedPhone,
                                    customerName: name || '',
                                    customerEmail: email || '',
                                    customerIdNumber: idNumber || '',
                                    customerDob: dob || '',
                                    customerOccupation: occupation || '',
                                    createdAt: serverTimestamp(),
                                    lastUpdatedAt: serverTimestamp(),
                                });
                                customerId = newCustomerRef.id;
                            } else {
                                customerId = snapshot.docs[0].id;
                            }
                        }
                        
                        const registrationRef = doc(registrationsCollection);
                        batch.set(registrationRef, {
                            eventId: eventId,
                            customerId: customerId,
                            customerName: name || '',
                            customerPhone: trimmedPhone,
                            customerEmail: email || '',
                            customerIdNumber: idNumber || '',
                            customerDob: dob || '',
                            customerOccupation: occupation || '',
                            createdAt: new Date(),
                            isCheckedIn: false,
                            addonTransport: false,
                            sources: ['batch_import'],
                            customFields: {},
                        });
                    }

                    await batch.commit();
                    alert(`æˆåŠŸåŒ¯å…¥ ${lines.length} ç­†è¨‚å–®ï¼`);
                    batchImportModal.classList.add('hidden');

                } catch (error) {
                    console.error("æ‰¹æ¬¡åŒ¯å…¥å¤±æ•—:", error);
                    alert(`æ‰¹æ¬¡åŒ¯å…¥å¤±æ•—: ${error.message}`);
                }
            });



            colorPaletteContainer.addEventListener('click', (e) => {
                if(e.target.dataset.color) {
                    Array.from(colorPaletteContainer.children).forEach(child => child.classList.remove('border-black', 'ring-2', 'ring-offset-2', 'ring-gray-800'));
                    e.target.classList.add('border-black', 'ring-2', 'ring-offset-2', 'ring-gray-800');
                    eventColorInput.value = e.target.dataset.color;
                }
            });

            customerDetailsContent.addEventListener('click', async (e) => {
                if (e.target.id === 'save-customer-notes-btn') {
                    const btn = e.target;
                    const customerId = btn.dataset.customerId;
                    const notes = document.getElementById('customer-notes-textarea').value;
                    if (!customerId) return;
                    try {
                        const docRef = doc(customersCollection, customerId);
                        await updateDoc(docRef, { notes });
                        btn.textContent = 'å·²å„²å­˜!';
                        setTimeout(() => { btn.textContent = 'å„²å­˜å‚™è¨»'; }, 2000);
                    } catch (error) {
                        console.error("å„²å­˜å‚™è¨»å¤±æ•—:", error);
                    }
                }

                if (e.target.id === 'edit-customer-btn') {
                    const displayDiv = customerDetailsContent.querySelector('#customer-info-display');
                    const formDiv = customerDetailsContent.querySelector('#customer-info-form');
                    displayDiv.classList.add('hidden');
                    formDiv.classList.remove('hidden');
                    e.target.classList.add('hidden');
                }

                if (e.target.id === 'cancel-customer-edit-btn') {
                    const displayDiv = customerDetailsContent.querySelector('#customer-info-display');
                    const formDiv = customerDetailsContent.querySelector('#customer-info-form');
                    displayDiv.classList.remove('hidden');
                    formDiv.classList.add('hidden');
                    customerDetailsContent.querySelector('#edit-customer-btn').classList.remove('hidden');
                }

                 if (e.target.id === 'delete-customer-btn') {
                    const customerId = e.target.dataset.customerId;
                    if (customerId && confirm('æ‚¨ç¢ºå®šè¦åˆªé™¤é€™ä½å®¢æˆ¶å—ï¼Ÿ\næ‰€æœ‰èˆ‡æ­¤å®¢æˆ¶ç›¸é—œçš„å ±åè¨‚å–®ç´€éŒ„å°‡æœƒè¢«ä¸€ä½µæ°¸ä¹…åˆªé™¤ï¼')) {
                        try {
                            const q = query(registrationsCollection, where("customerId", "==", customerId));
                            const registrationsSnapshot = await getDocs(q);

                            const batch = writeBatch(db);

                            registrationsSnapshot.forEach(doc => {
                                batch.delete(doc.ref);
                            });

                            batch.delete(doc(customersCollection, customerId));

                            await batch.commit();
                            customerDetailsModal.classList.add('hidden');
                        } catch (error) {
                             console.error("åˆªé™¤å®¢æˆ¶å¤±æ•—:", error);
                             alert("åˆªé™¤å®¢æˆ¶å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚");
                        }
                    }
                }
            });

            customerDetailsContent.addEventListener('submit', async (e) => {
                if (e.target.id === 'customer-info-form') {
                    e.preventDefault();
                    const form = e.target;
                    const customerId = form.dataset.customerId;
                    if (!customerId) return;

                    const updatedData = {
                        customerName: form.elements.customerName.value.trim(),
                        primaryPhone: form.elements.primaryPhone.value.trim(),
                        customerEmail: form.elements.customerEmail.value.trim(),
                        customerIdNumber: form.elements.customerIdNumber.value.trim(),
                        customerDob: form.elements.customerDob.value,
                        customerOccupation: form.elements.customerOccupation.value.trim(),
                        lastUpdatedAt: serverTimestamp(),
                    };

                    try {
                        const docRef = doc(customersCollection, customerId);
                        await updateDoc(docRef, updatedData);
                        
                        // Manually update the display div after saving
                        const displayDiv = customerDetailsContent.querySelector('#customer-info-display');
                        displayDiv.querySelector('[data-field="customerName"]').textContent = updatedData.customerName || 'N/A';
                        displayDiv.querySelector('[data-field="primaryPhone"]').textContent = updatedData.primaryPhone || 'N/A';
                        displayDiv.querySelector('[data-field="customerEmail"]').textContent = updatedData.customerEmail || 'N/A';
                        displayDiv.querySelector('[data-field="customerIdNumber"]').textContent = updatedData.customerIdNumber || 'N/A';
                        displayDiv.querySelector('[data-field="customerDob"]').textContent = updatedData.customerDob || 'N/A';
                        displayDiv.querySelector('[data-field="customerOccupation"]').textContent = updatedData.customerOccupation || 'N/A';
                        
                        // Toggle back to display view
                        displayDiv.classList.remove('hidden');
                        form.classList.add('hidden');
                        customerDetailsContent.querySelector('#edit-customer-btn').classList.remove('hidden');

                    } catch (error) {
                        console.error("æ›´æ–°å®¢æˆ¶è³‡æ–™å¤±æ•—:", error);
                    }
                }
            });

            eventForm.addEventListener('submit', handleEventFormSubmit);
            orderForm.addEventListener('submit', handleAddOrder);

            addCustomFieldBtn.addEventListener('click', () => {
                const newField = document.createElement('div');
                newField.className = 'custom-field-group grid grid-cols-10 gap-2 items-center';
                newField.innerHTML = `
                    <div class="col-span-4">
                        <input type="text" name="custom-key" placeholder="æ¬„ä½åç¨±" class="w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 text-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <div class="col-span-5">
                        <input type="text" name="custom-value" placeholder="æ¬„ä½å€¼" class="w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 text-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <div class="col-span-1">
                        <button type="button" class="remove-custom-field-btn text-red-500 hover:text-red-700 text-xl font-bold">&times;</button>
                    </div>`;
                customFieldsContainer.appendChild(newField);
            });

            customFieldsContainer.addEventListener('click', (e) => {
                if (e.target.classList.contains('remove-custom-field-btn')) {
                    e.target.closest('.custom-field-group').remove();
                }
            });

            registrationsListDiv.addEventListener('change', async (e) => {
                if (e.target.classList.contains('check-in-box')) {
                    const docId = e.target.dataset.docId;
                    const isChecked = e.target.checked;
                    if (!docId) return;
                    try {
                        await updateDoc(doc(registrationsCollection, docId), { isCheckedIn: isChecked });
                    } catch (error) {
                        console.error("æ›´æ–°å ±åˆ°ç‹€æ…‹å¤±æ•—:", error);
                    }
                }
            });
        }
    </script>
</body>
</html>

